;SOKOBAN

;GR.0, 40 x 25 characters
;We force it to address $8000 to make it aligned correctly.
_scr@$8000:array(0..39, 0..24) of byte

licznik_int:0..50
testowo:byte
testowo2:byte

poz_player_x:0..39
poz_player_y:0..24

rys_spychacza:77..80

;Display list
;const dl:array of dl_command = 3 times $70, $42, _scr, 2 times $02, $02+$80, 20 times $02, $41, dl
const dl:array = 2 times $70, $42, _scr, $10, 23 times $02, $10, $02, $41, dl

; CONSTANTS ------------------------------------------------------

;Font file
const fontFN1:font = file "sokoban1.fnt"

const fontFN2:font = file "sokoban2.fnt"

;Characters
;pod H jest 72
const
      GWIAZDKI1         = 74
      GWIAZDKI2         = 75
      GWIAZDKI3         = 76
      
      SPYCHACZ_G        = 77
      SPYCHACZ_P        = 78
      SPYCHACZ_D        = 79
      SPYCHACZ_L        = 80

      PODLOGA           = 0 ;???

      CEL'PUSTY         = 65
      CEL'PELNY         = 66
      BECZKA            = 67

      MUREK'L           = 68
      MUREK'S           = 69
      MUREK'P           = 70


;Levele

lev'max:0..1

const lev'mapa:array of byte = (
;--Level 0
     4,4,4,4,4,4,6
     4,0,0,5,0,1,6
     4,0,0,3,0,0,6
     4,8,0,3,0,0,6
     4,0,0,5,0,1,6
     4,4,4,4,4,4,6
;--1
     4,4,4,4,4,4,6,9
     4,0,0,0,0,0,5,6
     4,0,0,3,0,0,1,6
     4,8,0,3,0,0,1,6
     4,0,0,3,0,0,1,6
     4,0,0,0,0,0,5,6
     4,4,4,4,4,4,6,9
     )

const lev'rozmiar:array(lev'max, 0..1 ) = ( 
   7, 8
   6, 7
   )
   
losuj_gwiazde:proc >gwiazda:byte =
          gw = RANDOM mod 3
          if gw = 0 then gwiazda = GWIAZDKI1
          else if gw = 1 then gwiazda = GWIAZDKI2
          else if gw = 2 then gwiazda = GWIAZDKI3


rysuj_level:proc lev:byte =
   ;suzkamy gdzie zaczynaja sie dane levelu do narysowania
   pocz = 0
   aa = 0
   while aa < lev
      roz_x, roz_y = lev'rozmiar(aa,0), lev'rozmiar(aa,1)
      pocz = pocz +  roz_x * roz_y
      inc aa

   ;rozmiary levelu do narysowania
   lev2 = lev
   roz_x = lev'rozmiar(lev2, 0)
   roz_y = lev'rozmiar(lev2, 1)

   yy = 0

   while yy < roz_y
         xx = 0
             while xx < roz_x
               poz_z = pocz
               poz_z = poz_z + yy * roz_x + xx
               scr_xx = 10 + xx
               scr_yy = 10 + yy
               znak = lev'mapa(poz_z)
               if znak = 9 then znak = losuj_gwiazde
               else if znak = 8 then
                    znak = rys_spychacza
                    poz_player_x = scr_xx
                    poz_player_y = scr_yy
               else if znak <> 0 then znak = znak + 64

               _scr(scr_xx, scr_yy) = znak
               inc xx

           inc yy

;   _scr(20,4) = "[xx]    [yy]"
   

rysuj_tlo:proc =
   for x:0..39
      for y:0..24
           _scr(x,y) = losuj_gwiazde

cycle:vbi =
        inc licznik_int
        if licznik_int = 50 then licznik_int = 0

        if licznik_int = 0 then set'font fontFN2
        else if licznik_int = 25 then set'font fontFN1

;        inc licznik_joya
;        ;if licznik_joya < 255 then

;              _scr(5,5) ="      "
;              _scr(5,5) = "[licznik_joya]"

; START -------------------------------------------

;Initialize graphics.

set'font fontFN1

licznik_joya = 1

sdlstl = dl
COLOR0(2) = 0
COLOR0(5) = 0

;wlaczenie przerwania
on'vbi cycle

rys_spychacza = SPYCHACZ_G

rysuj_tlo

rysuj_level 1

mail_loop@

if STICK(0) = right
        rys_spychacza = SPYCHACZ_P
        _scr(poz_player_x,poz_player_y) = rys_spychacza
        testowo = licznik_int
        testowo = testowo + 25
        testowo = testowo mod 50
        testowo2 = licznik_int
        while testowo2 <> testowo (
             testowo2 = licznik_int
             _scr(5,5) = " "
        )
        _scr(poz_player_x,poz_player_y) = PODLOGA
        poz_player_x = poz_player_x + 1
        _scr(poz_player_x,poz_player_y) = rys_spychacza
else if STICK(0) = left
        rys_spychacza = SPYCHACZ_L
        _scr(poz_player_x,poz_player_y) = rys_spychacza
else if STICK(0) = up
        rys_spychacza = SPYCHACZ_G
        _scr(poz_player_x,poz_player_y) = rys_spychacza
else if STICK(0) = down
        rys_spychacza = SPYCHACZ_D
        _scr(poz_player_x,poz_player_y) = rys_spychacza


goto mail_loop